<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üåç EcoVision Pro - Advanced Ecosystem Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* All your CSS styles remain exactly the same */
    :root {
      --primary: #2e7d32;
      --primary-light: #60ad5e;
      --primary-dark: #005005;
      --secondary: #0288d1;
      --danger: #d32f2f;
      --warning: #ed6c02;
      --success: #388e3c;
      --text: #333;
      --text-light: #666;
      --bg: #f5f5f5;
      --card-bg: #fff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s ease;
    }
    
    [data-theme="dark"] {
      --primary: #4caf50;
      --primary-light: #80e27e;
      --primary-dark: #087f23;
      --secondary: #4fc3f7;
      --danger: #f44336;
      --warning: #ffa726;
      --success: #66bb6a;
      --text: #f5f5f5;
      --text-light: #b0bec5;
      --bg: #121212;
      --card-bg: #1e1e1e;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Rest of your CSS styles... */
    /* (Include all your existing CSS styles here exactly as you had them) */
    
    /* Additional styles for delete button */
    .history-item > div:first-child {
      flex: 1;
      cursor: pointer;
    }
    
    .delete-assessment-btn {
      opacity: 0.7;
      transition: var(--transition);
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 5px;
    }
    
    .delete-assessment-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <!-- Your HTML structure remains exactly the same -->
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-leaf fa-2x" style="color: var(--primary);"></i>
        <h1>EcoVision Pro</h1>
      </div>
      <div class="controls">
        <label class="toggle-switch">
          <input type="checkbox" id="theme-toggle">
          <span class="slider"></span>
        </label>
        <button id="print-btn" class="btn btn-outline">
          <i class="fas fa-print"></i> Print
        </button>
      </div>
    </header>
    
    <!-- Rest of your HTML remains exactly the same -->
    <!-- (Include all your existing HTML here exactly as you had it) -->
    
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Enhanced data model (same as before)
    const ecoData = {
      questions: [
        /* Your question data remains the same */
      ],
      recommendations: {
        /* Your recommendation data remains the same */
      },
      scoreDescriptions: {
        /* Your score descriptions remain the same */
      }
    };

    // App state (same as before)
    let appState = {
      currentAnswers: {},
      previousAssessments: [],
      currentScore: 0,
      charts: {},
      darkMode: false,
      map: null,
      marker: null,
      currentPhotos: [],
      photoCounter: 0
    };

    // DOM elements (same as before)
    const elements = {
      questionsContainer: document.getElementById('questions-container'),
      resultContainer: document.getElementById('result-container'),
      assessmentCard: document.getElementById('assessment-card'),
      progressFill: document.getElementById('progress-fill'),
      progressText: document.getElementById('progress-text'),
      submitBtn: document.getElementById('submit-btn'),
      scoreDisplay: document.getElementById('score-display'),
      scoreDescription: document.getElementById('score-description'),
      generalFeedback: document.getElementById('general-feedback'),
      recommendationsContainer: document.getElementById('recommendations-container'),
      timelineContainer: document.getElementById('timeline-container'),
      historyContainer: document.getElementById('history-container'),
      radarChartContainer: document.getElementById('radar-chart-container'),
      trendChartContainer: document.getElementById('trend-chart-container'),
      newAssessmentBtn: document.getElementById('new-assessment-btn'),
      saveSurveyBtn: document.getElementById('save-survey-btn'),
      savePhotosBtn: document.getElementById('save-photos-btn'),
      printBtn: document.getElementById('print-btn'),
      themeToggle: document.getElementById('theme-toggle'),
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content'),
      locationInput: document.getElementById('location-input'),
      saveLocationBtn: document.getElementById('save-location-btn'),
      mapContainer: document.getElementById('map-container'),
      map: document.getElementById('map'),
      mapPlaceholder: document.getElementById('map-placeholder'),
      uploadArea: document.getElementById('upload-area'),
      photoUpload: document.getElementById('photo-upload'),
      photoPreview: document.getElementById('photo-preview'),
      photoCaption: document.getElementById('photo-caption')
    };

    // Initialize the application
    function initApp() {
      loadPreviousAssessments();
      renderQuestions();
      setupEventListeners();
      checkProgress();
      initMap();
      initTheme();
    }

    // Initialize theme
    function initTheme() {
      const savedTheme = localStorage.getItem('darkMode');
      if (savedTheme === 'true') {
        enableDarkMode();
      } else {
        disableDarkMode();
      }
    }

    function enableDarkMode() {
      document.documentElement.setAttribute('data-theme', 'dark');
      appState.darkMode = true;
      localStorage.setItem('darkMode', 'true');
      elements.themeToggle.checked = true;
      refreshCharts();
    }

    function disableDarkMode() {
      document.documentElement.removeAttribute('data-theme');
      appState.darkMode = false;
      localStorage.setItem('darkMode', 'false');
      elements.themeToggle.checked = false;
      refreshCharts();
    }

    function toggleTheme() {
      if (appState.darkMode) {
        disableDarkMode();
      } else {
        enableDarkMode();
      }
    }

    function refreshCharts() {
      if (appState.previousAssessments.length > 0) {
        const lastAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
        if (appState.charts.radar) {
          createRadarChart(lastAssessment.categoryScores);
        }
        if (appState.charts.trend) {
          createTrendChart();
        }
      }
    }

    // Initialize Leaflet Map
    function initMap() {
      const defaultCoords = [0, 0]; // Default coordinates
      
      appState.map = L.map('map', {
        zoomControl: false
      }).setView(defaultCoords, 2);
      
      L.control.zoom({
        position: 'topright'
      }).addTo(appState.map);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(appState.map);
      
      // Create custom green marker
      const greenIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
      
      // Create marker (initially hidden)
      appState.marker = L.marker(defaultCoords, {
        icon: greenIcon,
        opacity: 0
      }).addTo(appState.map);
      
      // Ensure map fills container
      setTimeout(() => {
        appState.map.invalidateSize();
      }, 0);
      
      // Handle window resizing
      window.addEventListener('resize', () => {
        appState.map.invalidateSize();
      });
    }

    // Geocode location using OpenStreetMap's Nominatim
    function geocodeLocation(location) {
      if (!location) return;
      
      elements.mapPlaceholder.classList.add('hidden');
      
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            
            // Update map view
            appState.map.setView([lat, lon], 14);
            
            // Update marker
            appState.marker
              .setLatLng([lat, lon])
              .setOpacity(1)
              .bindPopup(`<strong>Assessment Location</strong><br>${location}`)
              .openPopup();
          } else {
            elements.mapPlaceholder.classList.remove('hidden');
            console.error('Location not found');
          }
        })
        .catch(error => {
          elements.mapPlaceholder.classList.remove('hidden');
          console.error('Geocoding error:', error);
        });
    }

    // Load previous assessments from localStorage
    function loadPreviousAssessments() {
      const savedAssessments = localStorage.getItem('ecoAssessments');
      if (savedAssessments) {
        appState.previousAssessments = JSON.parse(savedAssessments);
        renderHistory();
      }
    }

    // Render assessment questions
    function renderQuestions() {
      let html = '';
      
      ecoData.questions.forEach((question, index) => {
        html += `
          <div class="question" id="q-${question.id}">
            <div class="question-text">
              <span class="badge">Question ${index + 1}</span>
              ${question.text}
              <div class="tooltip">
                <i class="fas fa-info-circle"></i>
                <span class="tooltiptext">${question.description}</span>
              </div>
            </div>
            
            <div class="options">
              ${question.options.map(option => `
                <div class="option">
                  <input type="radio" 
                         id="${question.id}-${option.value}" 
                         name="${question.id}" 
                         value="${option.value}"
                         data-question="${question.id}">
                  <label for="${question.id}-${option.value}">
                    ${option.label}
                    <div class="small" style="margin-top: 5px;">${option.description}</div>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      
      elements.questionsContainer.innerHTML = html;
    }

    // Setup event listeners
    function setupEventListeners() {
      // Radio button changes
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const questionId = this.getAttribute('data-question');
          appState.currentAnswers[questionId] = parseInt(this.value);
          checkProgress();
        });
      });
      
      // Submit button
      elements.submitBtn.addEventListener('click', calculateScore);
      
      // New assessment button
      elements.newAssessmentBtn.addEventListener('click', resetAssessment);
      
      // Save survey button
      elements.saveSurveyBtn.addEventListener('click', saveSurvey);
      
      // Save photos button
      elements.savePhotosBtn.addEventListener('click', savePhotos);
      
      // Print button
      elements.printBtn.addEventListener('click', () => window.print());
      
      // Theme toggle
      elements.themeToggle.addEventListener('change', toggleTheme);
      
      // Tab switching
      elements.tabs.forEach(tab => {
        tab.addEventListener('click', switchTab);
      });
      
      // Save location
      elements.saveLocationBtn.addEventListener('click', saveLocation);
      
      // Photo upload handling
      elements.uploadArea.addEventListener('click', () => elements.photoUpload.click());
      
      // Drag and drop for photos
      elements.uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        elements.uploadArea.style.backgroundColor = 'rgba(46, 125, 50, 0.2)';
      });
      
      elements.uploadArea.addEventListener('dragleave', () => {
        elements.uploadArea.style.backgroundColor = '';
      });
      
      elements.uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.uploadArea.style.backgroundColor = '';
        handlePhotoUpload(e.dataTransfer.files);
      });
      
      // File input change
      elements.photoUpload.addEventListener('change', (e) => {
        handlePhotoUpload(e.target.files);
      });
    }

    // Handle photo uploads
    function handlePhotoUpload(files) {
      if (!files || files.length === 0) return;
      
      // Limit to 10 photos per assessment
      const remainingSlots = 10 - appState.currentPhotos.length;
      if (remainingSlots <= 0) {
        alert('Maximum of 10 photos per assessment reached');
        return;
      }
      
      const filesToUpload = Array.from(files).slice(0, remainingSlots);
      
      filesToUpload.forEach(file => {
        if (!file.type.match('image.*')) {
          alert(`Skipped ${file.name} - only image files are allowed`);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const photoId = `photo-${Date.now()}-${appState.photoCounter++}`;
          const photoObj = {
            id: photoId,
            data: e.target.result,
            file: file,
            caption: '',
            timestamp: new Date().toISOString()
          };
          
          appState.currentPhotos.push(photoObj);
          renderPhotoThumbnail(photoObj);
        };
        reader.readAsDataURL(file);
      });
      
      // Reset file input to allow uploading same files again
      elements.photoUpload.value = '';
    }

    // Render photo thumbnail in preview area
    function renderPhotoThumbnail(photo) {
      const thumbnail = document.createElement('div');
      thumbnail.style.position = 'relative';
      thumbnail.style.display = 'inline-block';
      
      const img = document.createElement('img');
      img.src = photo.data;
      img.className = 'photo-thumbnail';
      img.alt = 'Uploaded photo preview';
      
      const removeBtn = document.createElement('span');
      removeBtn.className = 'remove-photo';
      removeBtn.innerHTML = '&times;';
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removePhoto(photo.id);
      });
      
      thumbnail.appendChild(img);
      thumbnail.appendChild(removeBtn);
      elements.photoPreview.appendChild(thumbnail);
      
      // Add click to view larger
      thumbnail.addEventListener('click', () => viewPhoto(photo));
    }

    // Remove photo from current uploads
    function removePhoto(photoId) {
      appState.currentPhotos = appState.currentPhotos.filter(p => p.id !== photoId);
      
      // Re-render all thumbnails
      elements.photoPreview.innerHTML = '';
      appState.currentPhotos.forEach(photo => renderPhotoThumbnail(photo));
    }

    // View photo in larger view
    function viewPhoto(photo) {
      // Create modal overlay
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
      modal.style.display = 'flex';
      modal.style.flexDirection = 'column';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '1000';
      modal.style.padding = '20px';
      modal.style.boxSizing = 'border-box';
      
      // Create close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-danger';
      closeBtn.style.position = 'absolute';
      closeBtn.style.top = '20px';
      closeBtn.style.right = '20px';
      closeBtn.innerHTML = '<i class="fas fa-times"></i> Close';
      closeBtn.addEventListener('click', () => document.body.removeChild(modal));
      
      // Create image container
      const imgContainer = document.createElement('div');
      imgContainer.style.maxWidth = '90%';
      imgContainer.style.maxHeight = '80%';
      imgContainer.style.display = 'flex';
      imgContainer.style.justifyContent = 'center';
      imgContainer.style.alignItems = 'center';
      
      // Create image
      const img = document.createElement('img');
      img.src = photo.data;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      img.style.objectFit = 'contain';
      
      // Create caption
      const caption = document.createElement('div');
      caption.style.color = 'white';
      caption.style.marginTop = '15px';
      caption.style.textAlign = 'center';
      caption.textContent = photo.caption || 'No caption provided';
      
      // Add elements to modal
      imgContainer.appendChild(img);
      modal.appendChild(closeBtn);
      modal.appendChild(imgContainer);
      modal.appendChild(caption);
      
      // Add to document
      document.body.appendChild(modal);
    }

    // Save photos to current assessment
    function savePhotos() {
      // Update all photos with current caption
      const caption = elements.photoCaption.value.trim();
      appState.currentPhotos.forEach(photo => {
        if (!photo.caption) {
          photo.caption = caption;
        }
      });
      
      // Get current assessment
      const currentAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
      if (currentAssessment) {
        if (!currentAssessment.photos) {
          currentAssessment.photos = [];
        }
        
        // Add new photos
        currentAssessment.photos.push(...appState.currentPhotos);
        localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
        
        // Show success message
        alert(`${appState.currentPhotos.length} photos saved successfully!`);
        
        // Reset photo state
        appState.currentPhotos = [];
        elements.photoPreview.innerHTML = '';
        elements.photoCaption.value = '';
      } else {
        alert('Error: No current assessment found to attach photos to.');
      }
    }

    // Check progress and enable/disable submit button
    function checkProgress() {
      const answered = Object.keys(appState.currentAnswers).length;
      const total = ecoData.questions.length;
      const percent = Math.round((answered / total) * 100);
      
      elements.progressFill.style.width = `${percent}%`;
      elements.progressText.textContent = `${percent}% complete (${answered}/${total} questions)`;
      
      elements.submitBtn.disabled = answered < total;
    }

    // Calculate assessment score
    function calculateScore() {
      // Calculate raw score
      let rawScore = 0;
      let maxScore = 0;
      const categoryScores = {};
      
      ecoData.questions.forEach(question => {
        const value = appState.currentAnswers[question.id] || 0;
        rawScore += value;
        maxScore += 3;
        
        // For radar chart
        const category = question.text;
        categoryScores[category] = value;
      });
      
      // Calculate percentage
      const percentScore = Math.round((rawScore / maxScore) * 100);
      appState.currentScore = percentScore;
      
      // Save assessment
      saveAssessment(percentScore, categoryScores);
      
      // Display results
      displayResults(percentScore, categoryScores);
    }

    // Display assessment results
    function displayResults(score, categoryScores) {
      // Show result container
      elements.assessmentCard.classList.add('hidden');
      elements.resultContainer.classList.remove('hidden');
      
      // Set score display
      elements.scoreDisplay.textContent = score;
      
      // Determine score category
      let scoreClass, description;
      if (score < 40) {
        scoreClass = 'score-low';
        description = ecoData.scoreDescriptions.low;
      } else if (score < 70) {
        scoreClass = 'score-medium';
        description = ecoData.scoreDescriptions.medium;
      } else {
        scoreClass = 'score-high';
        description = ecoData.scoreDescriptions.high;
      }
      
      // Apply score class
      elements.scoreDisplay.className = `score-display ${scoreClass} pulse`;
      elements.scoreDescription.textContent = description;
      elements.generalFeedback.textContent = description;
      
      // Render recommendations
      renderRecommendations(score);
      
      // Create radar chart
      createRadarChart(categoryScores);
      
      // Create trend chart if we have history
      if (appState.previousAssessments.length > 0) {
        createTrendChart();
      }
      
      // Scroll to results
      elements.resultContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Render recommendations based on score
    function renderRecommendations(score) {
      let recommendations;
      if (score < 40) {
        recommendations = ecoData.recommendations.low;
      } else if (score < 70) {
        recommendations = ecoData.recommendations.medium;
      } else {
        recommendations = ecoData.recommendations.high;
      }
      
      // Render recommendations
      let html = recommendations.map(rec => `
        <div class="recommendation">
          <i class="${rec.icon}"></i>
          <div>
            <h4>${rec.title} <span class="badge">${rec.priority} Priority</span></h4>
            <p>${rec.description}</p>
            <p class="small"><strong>Timeline:</strong> ${rec.timeline}</p>
          </div>
        </div>
      `).join('');
      
      elements.recommendationsContainer.innerHTML = html;
      
      // Render timeline
      const timelineHtml = `
        <div style="margin-top: 20px;">
          ${recommendations.map(rec => `
            <div style="margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${rec.title}</span>
                <span>${rec.timeline}</span>
              </div>
              <div style="height: 10px; background-color: #e0e0e0; border-radius: 5px;">
                <div style="height: 100%; width: ${getTimelineWidth(rec.timeline)}; 
                     background-color: var(--primary); border-radius: 5px;"></div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      elements.timelineContainer.innerHTML = timelineHtml;
    }

    // Helper function for timeline visualization
    function getTimelineWidth(timeline) {
      switch (timeline.toLowerCase()) {
        case 'immediate': return '20%';
        case 'within 1 month': return '30%';
        case 'within 3 months': return '50%';
        case 'within 6 months': return '70%';
        case 'next planting season': return '80%';
        case 'within 1 year': return '90%';
        case 'ongoing': return '100%';
        default: return '50%';
      }
    }

    // Create radar chart for category scores
    function createRadarChart(categoryScores) {
      const ctx = document.getElementById('radar-chart').getContext('2d');
      
      // Destroy previous chart if exists
      if (appState.charts.radar) {
        appState.charts.radar.destroy();
      }
      
      const labels = Object.keys(categoryScores);
      const data = Object.values(categoryScores);
      
      appState.charts.radar = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Category Scores',
            data: data,
            backgroundColor: 'rgba(46, 125, 50, 0.2)',
            borderColor: 'rgba(46, 125, 50, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(46, 125, 50, 1)',
            pointRadius: 4
          }]
        },
        options: {
          scales: {
            r: {
              angleLines: {
                display: true
              },
              suggestedMin: 0,
              suggestedMax: 3,
              ticks: {
                stepSize: 1
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw}/3`;
                }
              }
            }
          }
        }
      });
    }

    // Create trend chart for historical data
    function createTrendChart() {
      const ctx = document.getElementById('trend-chart').getContext('2d');
      
      // Destroy previous chart if exists
      if (appState.charts.trend) {
        appState.charts.trend.destroy();
      }
      
      // Prepare data
      const assessments = [...appState.previousAssessments].reverse();
      const labels = assessments.map(a => a.date);
      const scores = assessments.map(a => a.score);
      const locations = assessments.map(a => a.location || 'Unspecified');
      
      appState.charts.trend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ecosystem Health Score',
            data: scores,
            backgroundColor: 'rgba(46, 125, 50, 0.2)',
            borderColor: 'rgba(46, 125, 50, 1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  const index = context.dataIndex;
                  return `Location: ${locations[index]}`;
                }
              }
            }
          }
        }
      });
    }

    // Save current assessment
    function saveAssessment(score, categoryScores) {
      const assessment = {
        date: new Date().toLocaleDateString(),
        score: score,
        categoryScores: categoryScores,
        answers: appState.currentAnswers,
        timestamp: new Date().getTime()
      };
      
      appState.previousAssessments.push(assessment);
      localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
      
      // Update history display
      renderHistory();
    }

    // Render assessment history with delete buttons
    function renderHistory() {
      if (appState.previousAssessments.length === 0) {
        elements.historyContainer.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-light);">
            <i class="fas fa-history fa-2x" style="margin-bottom: 10px;"></i>
            <p>No previous assessments found</p>
          </div>
        `;
        return;
      }
      
      // Sort by date (newest first)
      const sortedAssessments = [...appState.previousAssessments].sort((a, b) => b.timestamp - a.timestamp);
      
      let html = sortedAssessments.map((assessment, index) => {
        let scoreClass;
        if (assessment.score < 40) {
          scoreClass = 'score-low';
        } else if (assessment.score < 70) {
          scoreClass = 'score-medium';
        } else {
          scoreClass = 'score-high';
        }
        
        // Check if this assessment has photos
        const hasPhotos = assessment.photos && assessment.photos.length > 0;
        
        return `
          <div class="history-item">
            <div data-index="${index}">
              <strong>${assessment.date}</strong>
              <div class="small">${assessment.location || 'No location specified'}</div>
              ${hasPhotos ? '<span class="badge"><i class="fas fa-camera"></i> Photos</span>' : ''}
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <div class="history-score ${scoreClass}">${assessment.score}/100</div>
              <button class="delete-assessment-btn" data-index="${index}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      elements.historyContainer.innerHTML = html;
      
      // Add click handlers to view historical assessments
      document.querySelectorAll('.history-item > div:first-child').forEach(item => {
        item.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          viewHistoricalAssessment(index);
        });
      });
      
      // Add click handlers to delete buttons
      document.querySelectorAll('.delete-assessment-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation(); // Prevent triggering the history item click
          const index = parseInt(this.getAttribute('data-index'));
          deleteAssessment(index);
        });
      });
    }

    // Delete an assessment from history
    function deleteAssessment(index) {
      if (confirm('Are you sure you want to delete this assessment? This cannot be undone.')) {
        // Remove the assessment from the array
        appState.previousAssessments.splice(index, 1);
        
        // Update localStorage
        localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
        
        // Re-render history
        renderHistory();
        
        // If we deleted the current assessment being viewed, reset the view
        if (elements.resultContainer.classList.contains('active')) {
          const currentAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
          if (!currentAssessment) {
            resetAssessment();
          }
        }
      }
    }

    // View historical assessment details
    function viewHistoricalAssessment(index) {
      const assessment = appState.previousAssessments[index];
      
      // Display the assessment
      elements.scoreDisplay.textContent = assessment.score;
      
      let scoreClass;
      if (assessment.score < 40) {
        scoreClass = 'score-low';
      } else if (assessment.score < 70) {
        scoreClass = 'score-medium';
      } else {
        scoreClass = 'score-high';
      }
      
      elements.scoreDisplay.className = `score-display ${scoreClass}`;
      elements.scoreDescription.textContent = 
        assessment.score < 40 ? ecoData.scoreDescriptions.low :
        assessment.score < 70 ? ecoData.scoreDescriptions.medium :
        ecoData.scoreDescriptions.high;
      
      // Update location if exists
      if (assessment.location) {
        elements.locationInput.value = assessment.location;
        geocodeLocation(assessment.location);
      } else {
        elements.locationInput.value = '';
        elements.mapPlaceholder.classList.remove('hidden');
      }
      
      // Create radar chart for historical data
      createRadarChart(assessment.categoryScores);
      
      // Switch to summary tab
      switchTab({ target: document.querySelector('.tab[data-tab="summary"]') });
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Save biodiversity survey
    function saveSurvey() {
      const survey = {
        date: document.getElementById('survey-date').value || new Date().toISOString().split('T')[0],
        plantSpecies: document.getElementById('plant-species').value





            // View historical assessment details
    function viewHistoricalAssessment(index) {
      const assessment = appState.previousAssessments[index];
      
      // Display the assessment
      elements.scoreDisplay.textContent = assessment.score;
      
      let scoreClass;
      if (assessment.score < 40) {
        scoreClass = 'score-low';
      } else if (assessment.score < 70) {
        scoreClass = 'score-medium';
      } else {
        scoreClass = 'score-high';
      }
      
      elements.scoreDisplay.className = `score-display ${scoreClass}`;
      elements.scoreDescription.textContent = 
        assessment.score < 40 ? ecoData.scoreDescriptions.low :
        assessment.score < 70 ? ecoData.scoreDescriptions.medium :
        ecoData.scoreDescriptions.high;
      
      // Update location if exists
      if (assessment.location) {
        elements.locationInput.value = assessment.location;
        geocodeLocation(assessment.location);
      } else {
        elements.locationInput.value = '';
        elements.mapPlaceholder.classList.remove('hidden');
      }
      
      // Create radar chart for historical data
      createRadarChart(assessment.categoryScores);
      
      // Switch to summary tab
      switchTab({ target: document.querySelector('.tab[data-tab="summary"]') });
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Save biodiversity survey
    function saveSurvey() {
      const survey = {
        date: document.getElementById('survey-date').value || new Date().toISOString().split('T')[0],
        plantSpecies: document.getElementById('plant-species').value,
        animalSpecies: document.getElementById('animal-species').value,
        dominantSpecies: document.getElementById('dominant-species').value,
        rareSpecies: document.getElementById('rare-species').value,
        notes: document.getElementById('survey-notes').value
      };
      
      // Get current assessment
      const currentAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
      if (currentAssessment) {
        currentAssessment.survey = survey;
        localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
        
        // Show success message
        alert('Biodiversity survey saved successfully!');
      } else {
        alert('Error: No current assessment found to attach survey to.');
      }
    }

    // Save location information
    function saveLocation() {
      const location = elements.locationInput.value.trim();
      if (!location) return;
      
      // Get current assessment
      const currentAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
      if (currentAssessment) {
        currentAssessment.location = location;
        localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
        
        // Update map
        geocodeLocation(location);
      }
    }

    // Reset assessment to start new one
    function resetAssessment() {
      // Reset state
      appState.currentAnswers = {};
      appState.currentPhotos = [];
      
      // Reset UI
      elements.assessmentCard.classList.remove('hidden');
      elements.resultContainer.classList.add('hidden');
      elements.progressFill.style.width = '0%';
      elements.progressText.textContent = '0% complete';
      elements.submitBtn.disabled = true;
      elements.photoPreview.innerHTML = '';
      elements.photoCaption.value = '';
      
      // Uncheck all radio buttons
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
      });
      
      // Reset map
      elements.mapPlaceholder.classList.remove('hidden');
      appState.marker.setOpacity(0);
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Switch between tabs
    function switchTab(e) {
      const tab = e.target.getAttribute('data-tab');
      
      // Update active tab
      elements.tabs.forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      
      // Show corresponding content
      elements.tabContents.forEach(content => {
        content.classList.remove('active');
        if (content.id === `${tab}-tab`) {
          content.classList.add('active');
        }
      });
      
      // If switching to photos tab, clear any current uploads
      if (tab === 'photos') {
        appState.currentPhotos = [];
        elements.photoPreview.innerHTML = '';
        elements.photoCaption.value = '';
      }
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
