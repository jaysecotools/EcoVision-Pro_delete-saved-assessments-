  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üåç EcoVision Elite - Advanced Ecosystem Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #2e7d32;
      --primary-light: #60ad5e;
      --primary-dark: #005005;
      --secondary: #0288d1;
      --danger: #d32f2f;
      --warning: #ed6c02;
      --success: #388e3c;
      --text: #333;
      --text-light: #666;
      --bg: #f5f5f5;
      --card-bg: #fff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s ease;
    }
    
    [data-theme="dark"] {
      --primary: #4caf50;
      --primary-light: #80e27e;
      --primary-dark: #087f23;
      --secondary: #4fc3f7;
      --danger: #f44336;
      --warning: #ffa726;
      --success: #66bb6a;
      --text: #f5f5f5;
      --text-light: #b0bec5;
      --bg: #121212;
      --card-bg: #1e1e1e;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    
    body {
      font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      transition: var(--transition);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Welcome Screen Styles */
    .welcome-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
      text-align: center;
    }

    .welcome-title {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .welcome-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      margin-top: 40px;
      width: 100%;
    }

    .welcome-card {
      background-color: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
      width: 300px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .welcome-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .welcome-card i {
      font-size: 3rem;
      color: var(--primary);
    }

    .welcome-card h3 {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .welcome-card p {
      color: var(--text-light);
    }
    
    /* Map Container Styles */
    #map-container {
      position: relative;
      height: 250px;
      width: 100%;
      border-radius: var(--radius);
      margin: 20px 0;
      overflow: hidden;
    }
    
    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .map-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: rgba(0,0,0,0.05);
      color: var(--text-light);
      z-index: 1000;
    }

    #map-container, #map {
      height: 100%;
      width: 100%;
      min-height: 250px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    h1 {
      font-size: 2.5rem;
      color: var(--primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 25px;
      margin-bottom: 25px;
      transition: var(--transition);
    }
    
    .card-title {
      font-size: 1.5rem;
      margin-bottom: 15px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .progress-container {
      margin: 20px 0;
    }
    
    .progress-bar {
      height: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 5px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-light), var(--primary));
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 5px;
    }
    
    .progress-text {
      text-align: right;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    .question {
      margin: 20px 0;
      padding: 15px;
      border-left: 4px solid var(--primary);
      background-color: rgba(46, 125, 50, 0.05);
      border-radius: 0 var(--radius) var(--radius) 0;
    }
    
    .question-text {
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .option {
      flex: 1;
      min-width: 120px;
    }
    
    .option input[type="radio"] {
      display: none;
    }
    
    .option label {
      display: block;
      padding: 12px 15px;
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: var(--radius);
      cursor: pointer;
      text-align: center;
      transition: var(--transition);
    }
    
    .option input[type="radio"]:checked + label {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
    }
    
    .option:hover label {
      background-color: rgba(46, 125, 50, 0.1);
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #0277bd;
      transform: translateY(-2px);
    }
    
    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background-color: rgba(46, 125, 50, 0.1);
    }
    
    .hidden {
      display: none !important;
    }
    
    .result-container {
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .score-display {
      font-size: 3rem;
      font-weight: 700;
      text-align: center;
      margin: 20px 0;
    }
    
    .score-low { color: var(--danger); }
    .score-medium { color: var(--warning); }
    .score-high { color: var(--success); }
    
    .feedback {
      margin: 25px 0;
      padding: 20px;
      border-radius: var(--radius);
      background-color: rgba(2, 136, 209, 0.1);
      border-left: 4px solid var(--secondary);
    }
    
    .recommendation {
      margin: 10px 0;
      padding: 15px;
      background-color: rgba(46, 125, 50, 0.1);
      border-radius: var(--radius);
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    
    .recommendation i {
      color: var(--primary);
      font-size: 1.2rem;
      margin-top: 2px;
    }
    
    .visualization {
      margin: 30px 0;
      height: 300px;
      background-color: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
    }
    
    .history-item {
      padding: 15px;
      margin: 10px 0;
      background-color: var(--card-bg);
      border-radius: var(--radius);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .history-item:hover {
      transform: translateX(5px);
      box-shadow: var(--shadow);
    }
    
    .history-score {
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 20px;
      background-color: rgba(46, 125, 50, 0.2);
    }
    
    .survey-question {
      margin: 20px 0;
    }
    
    .survey-question label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      background-color: var(--card-bg);
      color: var(--text);
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
    }
    
    .tab.active {
      border-bottom-color: var(--primary);
      font-weight: 600;
      color: var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    /* Icons for dark toggle slider */
    .toggle-switch .sun::after,
    .toggle-switch .moon::after {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      transition: opacity 0.3s;
    }

    .toggle-switch .sun::after {
      content: "\f185"; /* Sun icon */
      left: 10px;
      opacity: 1;
    }

    .toggle-switch .moon::after {
      content: "\f186"; /* Moon icon */
      right: 10px;
      opacity: 0.5;
    }

    .toggle-switch input:checked + .slider .sun::after {
      opacity: 0.5;
    }

    .toggle-switch input:checked + .slider .moon::after {
      opacity: 1;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      z-index: 2;
    }
    
    input:checked + .slider {
      background-color: var(--primary);
    }
    
    input:checked + .slider:before {
      transform: translateX(30px);
    }
    
    .toggle-switch input:checked + .slider {
      background-color: var(--primary);
    }

    .toggle-switch input:checked + .slider:before {
      transform: translateX(40px);
    }

    .location-input {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .location-input input {
      flex: 1;
    }
    
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      background-color: var(--primary-light);
      color: white;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
      margin-left: 5px;
      cursor: help;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    .delete-assessment-btn {
      transition: var(--transition);
      opacity: 0.7;
      padding: 5px;
      border-radius: 50%;
    }

    .delete-assessment-btn:hover {
      opacity: 1;
      background-color: rgba(211, 47, 47, 0.1);
      transform: scale(1.1);
    }

    .history-item:hover .delete-assessment-btn {
      display: block;
    }

    /* Add to your CSS */
    #assessment-name {
      margin-bottom: 15px;
    }

    .assessment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .assessment-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary);
    }

/* Modal Styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background-color: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  width: 90%;
  max-width: 800px;
  max-height: 80vh;
  overflow-y: auto;
  padding: 25px;
  position: relative;
}

.close-modal {
  position: absolute;
  top: 15px;
  right: 15px;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--text-light);
}

.close-modal:hover {
  color: var(--danger);
}

.modal-body {
  padding: 15px 0;
}

.modal-body h3 {
  color: var(--primary);
  margin-top: 20px;
  border-bottom: 1px solid var(--primary-light);
  padding-bottom: 5px;
}

.modal-body ul, .modal-body ol {
  margin-left: 20px;
  margin-bottom: 15px;
}

    /* Photo upload styles */
    .photo-upload-container {
      margin: 20px 0;
    }
    
    .photo-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .photo-thumbnail {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: var(--radius);
      border: 2px solid var(--primary-light);
      position: relative;
    }
    
    .remove-photo {
      position: absolute;
      top: -10px;
      right: -10px;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
    }
    
    .upload-area {
      border: 2px dashed var(--primary);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 15px;
    }
    
    .upload-area:hover {
      background-color: rgba(46, 125, 50, 0.1);
    }
    
    .upload-area i {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 10px;
    }
    
    .photo-caption-input {
      margin-top: 10px;
      width: 100%;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .options {
        flex-direction: column;
      }
      
      .option {
        width: 100%;
      }
      
      .photo-thumbnail {
        width: 80px;
        height: 80px;
      }
      
      .map-container {
        height: 250px;
      }

      .welcome-cards {
        flex-direction: column;
        align-items: center;
      }

      .welcome-card {
        width: 100%;
      }
    }
    
    /* Animation classes */
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* Leaflet Control Styling */
    .leaflet-control {
      background-color: var(--card-bg) !important;
      border-radius: var(--radius) !important;
      box-shadow: var(--shadow) !important;
      transition: var(--transition);
    }
    
    .leaflet-popup-content {
      font-family: inherit !important;
      padding: 10px !important;
    }
    
    .leaflet-popup-content-wrapper {
      border-radius: var(--radius) !important;
    }

    /* PDF Export Styles */
    .pdf-container {
      padding: 20px;
      background-color: white;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
    }

    .pdf-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #2e7d32;
      padding-bottom: 20px;
    }

    .pdf-logo {
      font-size: 2rem;
      color: #2e7d32;
      margin-bottom: 10px;
    }

    .pdf-section {
      margin-bottom: 20px;
      page-break-inside: avoid;
    }

    .pdf-section-title {
      background-color: #f0f0f0;
      padding: 8px 12px;
      border-left: 4px solid #2e7d32;
      margin-bottom: 15px;
    }

    .pdf-score {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
    }

    .pdf-score-low { background-color: #ffebee; color: #d32f2f; }
    .pdf-score-medium { background-color: #fff8e1; color: #ed6c02; }
    .pdf-score-high { background-color: #e8f5e9; color: #2e7d32; }

    .pdf-photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .pdf-photo {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
    }

    .pdf-photo img {
      max-width: 100%;
      height: auto;
    }

    .pdf-photo-caption {
      font-size: 0.8rem;
      margin-top: 5px;
    }

    .pdf-footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.8rem;
      color: #666;
      border-top: 1px solid #ddd;
      padding-top: 15px;
    }

/* Timeline styling */
.timeline {
  margin-top: 20px;
}
.timeline-item {
  display: flex;
  margin-bottom: 15px;
  align-items: center;
}
.timeline-priority {
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: bold;
  margin-right: 15px;
  min-width: 80px;
  text-align: center;
}
.timeline-priority.critical {
  background-color: var(--danger);
  color: white;
}
.timeline-priority.high {
  background-color: var(--warning);
  color: var(--text);
}
.timeline-priority.medium {
  background-color: var(--secondary);
  color: white;
}
.timeline-priority.low {
  background-color: var(--primary-light);
  color: white;
}
.timeline-content {
  flex: 1;
}
.timeline-bar {
  height: 8px;
  background-color: var(--primary);
  border-radius: 4px;
  margin: 5px 0;
}

/* Radar chart adjustments */
#radar-chart {
  max-height: 400px;
}
  </style>
</head>
<body>
  <!-- Welcome Screen -->
  <div class="container" id="welcome-screen">
    <header>
      <div class="logo">
        <i class="fas fa-leaf fa-2x" style="color: var(--primary);"></i>
        <h1>EcoVision Elite</h1>
      </div>
      <div class="controls">
        <label class="toggle-switch">
          <input type="checkbox" id="theme-toggle">
          <span class="slider">
            <span class="sun"></span>
            <span class="moon"></span>
          </span>
        </label>
      </div>
    </header>
    
    <div class="welcome-container">
      <h1 class="welcome-title">
        <i class="fas fa-leaf"></i> Ecosystem Health Assessment
      </h1>
      <p style="max-width: 600px; margin: 0 auto;">
        Welcome to EcoVision Elite, your comprehensive tool for evaluating and tracking ecosystem health. 
        Create new assessments, review past data, or import existing assessments to get started.
      </p>
      
      <div class="welcome-cards">
        <div class="welcome-card" id="new-assessment-card">
          <i class="fas fa-clipboard-check"></i>
          <h3>New Assessment</h3>
          <p>Start a new ecosystem health assessment to evaluate your local environment.</p>
        </div>
        
        <div class="welcome-card" id="view-assessments-card">
          <i class="fas fa-history"></i>
          <h3>View Assessments</h3>
          <p>Review and analyze your previous ecosystem assessments and trends.</p>
        </div>
        
        <div class="welcome-card" id="import-data-card">
          <i class="fas fa-file-import"></i>
          <h3>Import Data</h3>
          <p>Import previously exported assessments to continue your analysis.</p>
        </div>

  
  <div class="welcome-card" id="user-guide-card">
    <i class="fas fa-book"></i>
    <h3>User Guide</h3>
    <p>How to use EcoVision Elite</p>
  </div>
  
  <div class="welcome-card" id="terms-of-use-card">
    <i class="fas fa-file-contract"></i>
    <h3>Terms of Use</h3>
    <p>Legal information</p>
  </div>
</div>
    </div>
  </div>

  <!-- Assessment Screen (Hidden Initially) -->
  <div class="container hidden" id="app-container">
    <header>
      <div class="logo">
        <i class="fas fa-leaf fa-2x" style="color: var(--primary);"></i>
        <h1>EcoVision Elite</h1>
      </div>
      <div class="controls">
        <label class="toggle-switch">
          <input type="checkbox" id="theme-toggle">
          <span class="slider">
            <span class="sun"></span>
            <span class="moon"></span>
          </span>
        </label>
        <button id="export-file-btn" class="btn btn-outline">
          <i class="fas fa-save"></i> Save to File
        </button>
        <button id="print-btn" class="btn btn-outline">
          <i class="fas fa-print"></i> Print
        </button>
        <button id="export-pdf-btn" class="btn btn-outline">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button id="back-btn" class="btn btn-outline">
          <i class="fas fa-arrow-left"></i> Back
        </button>
      </div>
    </header>
    
    <div class="card" id="assessment-card">
      <h2 class="card-title">
        <i class="fas fa-clipboard-check"></i> Ecosystem Health Assessment
      </h2>
      <p>Complete this assessment to evaluate the health of your local ecosystem. Answer each question based on your observations.</p>
      
      <div class="survey-question">
        <label for="assessment-name">Assessment Name</label>
        <input type="text" id="assessment-name" class="form-control" placeholder="Give this assessment a descriptive name">
      </div>
      
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text">0% complete</div>
      </div>
      
      <div id="questions-container"></div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button id="submit-btn" class="btn btn-primary" disabled>
          <i class="fas fa-calculator"></i> Calculate Score
        </button>
      </div>
    </div>
    
    <div class="card result-container hidden" id="result-container">
      <h2 class="card-title">
        <i class="fas fa-chart-line"></i> Assessment Results
      </h2>
      
      <div style="text-align: center;">
        <div class="score-display" id="score-display">0</div>
        <div id="score-description">Loading assessment...</div>
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="summary">Summary</div>
        <div class="tab" data-tab="recommendations">Recommendations</div>
        <div class="tab" data-tab="history">History</div>
        <div class="tab" data-tab="survey">Biodiversity Survey</div>
        <div class="tab" data-tab="photos">Photo Documentation</div>
      </div>
      
      <div class="tab-content active" id="summary-tab">
        <div class="feedback">
          <h3><i class="fas fa-info-circle"></i> Overview</h3>
          <p id="general-feedback">Your ecosystem assessment is being calculated...</p>
        </div>
        
        <div class="visualization" id="radar-chart-container">
          <canvas id="radar-chart"></canvas>
        </div>
        
        <div class="location-input">
          <input type="text" id="location-input" class="form-control" placeholder="Enter assessment location (e.g., Central Park, New York)">
          <button id="save-location-btn" class="btn btn-primary">
            <i class="fas fa-save"></i> Save
          </button>
        </div>
        
        <div class="map-container" id="map-container">
          <div id="map"></div>
          <div class="map-placeholder" id="map-placeholder">
            <i class="fas fa-map-marked-alt fa-3x"></i>
            <p>Location map will display here</p>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="recommendations-tab">
        <h3><i class="fas fa-lightbulb"></i> Actionable Recommendations</h3>
        <p>Based on your assessment results, here are specific actions you can take to improve your ecosystem health:</p>
        
        <div id="recommendations-container"></div>
        
        <div class="feedback" style="margin-top: 20px;">
          <h3><i class="fas fa-calendar-alt"></i> Suggested Timeline</h3>
          <p>For best results, implement these recommendations according to the following timeline:</p>
          <div id="timeline-container"></div>
        </div>
      </div>
      
      <div class="tab-content" id="history-tab">
        <h3><i class="fas fa-history"></i> Assessment History</h3>
        <p>Review your previous ecosystem assessments to track changes over time:</p>
        
        <div id="history-container"></div>
        
        <div style="text-align: center; margin: 20px 0;">
          <button id="export-btn" class="btn btn-outline">
            <i class="fas fa-file-export"></i> Export All
          </button>
          <button id="import-btn" class="btn btn-outline">
            <i class="fas fa-file-import"></i> Import
          </button>
          <input type="file" id="import-file" accept=".json" style="display: none;">
        </div>

        <div class="visualization" id="trend-chart-container">
          <canvas id="trend-chart"></canvas>
        </div>
      </div>
      
      <div class="tab-content" id="survey-tab">
        <h3><i class="fas fa-binoculars"></i> Biodiversity Survey</h3>
        <p>Document the species present in your ecosystem to track biodiversity changes:</p>
        
        <div id="survey-container">
          <div class="survey-question">
            <label for="survey-date">Survey Date</label>
            <input type="date" id="survey-date" class="form-control" value="">
          </div>
          
          <div class="survey-question">
            <label for="plant-species">Native Plant Species Count</label>
            <input type="number" id="plant-species" class="form-control" min="0" placeholder="Estimated number of native plant species">
          </div>
          
          <div class="survey-question">
            <label for="animal-species">Animal Species Observed</label>
            <input type="number" id="animal-species" class="form-control" min="0" placeholder="Number of animal species observed">
          </div>
          
          <div class="survey-question">
            <label for="dominant-species">Dominant Species</label>
            <input type="text" id="dominant-species" class="form-control" placeholder="List dominant species separated by commas">
          </div>
          
          <div class="survey-question">
            <label for="rare-species">Rare/Endangered Species</label>
            <input type="text" id="rare-species" class="form-control" placeholder="List any rare or endangered species observed">
          </div>
          
          <div class="survey-question">
            <label for="survey-notes">Additional Notes</label>
            <textarea id="survey-notes" class="form-control" rows="4" placeholder="Record any other observations..."></textarea>
          </div>
          
          <div style="text-align: center; margin-top: 20px;">
            <button id="save-survey-btn" class="btn btn-primary">
              <i class="fas fa-save"></i> Save Survey
            </button>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="photos-tab">
        <h3><i class="fas fa-camera"></i> Photo Documentation</h3>
        <p>Upload photos to document the current state of the ecosystem. These will be attached to your assessment.</p>
        
        <div class="photo-upload-container">
          <div class="upload-area" id="upload-area">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload photos or drag and drop files here</p>
            <input type="file" id="photo-upload" accept="image/*" multiple style="display: none;">
          </div>
          
          <div class="photo-preview" id="photo-preview"></div>
          
          <div class="survey-question">
            <label for="photo-caption">Photo Caption/Notes</label>
            <input type="text" id="photo-caption" class="form-control photo-caption-input" placeholder="Add caption for these photos (optional)">
          </div>
          
          <div style="text-align: center; margin-top: 20px;">
            <button id="save-photos-btn" class="btn btn-primary">
              <i class="fas fa-save"></i> Save Photos
            </button>
          </div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button id="new-assessment-btn" class="btn btn-secondary">
          <i class="fas fa-redo"></i> Start New Assessment
        </button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // =============================================
    // DATA MODEL
    // =============================================
    const ecoData = {
      questions: [
        {
          id: "plant-diversity",
          text: "Native plant species diversity",
          description: "Assess the variety and abundance of native plant species in the area.",
          options: [
            { value: 3, label: "High Diversity", description: "Many native species present with good distribution" },
            { value: 2, label: "Moderate Diversity", description: "Several native species but some dominance by a few" },
            { value: 1, label: "Low Diversity", description: "Few native species, possibly dominated by invasives" }
          ]
        },
        {
          id: "soil-health",
          text: "Soil health and erosion",
          description: "Evaluate soil quality and signs of erosion or degradation.",
          options: [
            { value: 3, label: "Healthy Soil", description: "Minimal erosion, good structure, abundant organic matter" },
            { value: 2, label: "Moderate Health", description: "Some erosion or compaction but recovering" },
            { value: 1, label: "Poor Health", description: "Significant erosion, compaction, or degradation" }
          ]
        },
        {
          id: "water-quality",
          text: "Water quality indicators",
          description: "Assess visible water quality indicators in nearby water bodies.",
          options: [
            { value: 3, label: "Excellent", description: "Clear water, diverse aquatic life, no pollution signs" },
            { value: 2, label: "Moderate", description: "Some turbidity or limited aquatic diversity" },
            { value: 1, label: "Poor", description: "Cloudy water, algae blooms, or pollution signs" }
          ]
        },
        {
          id: "invasive-species",
          text: "Presence of invasive species",
          description: "Evaluate the presence and impact of invasive plant or animal species.",
          options: [
            { value: 3, label: "Minimal", description: "Few or no invasive species present" },
            { value: 2, label: "Moderate", description: "Some invasive species but not dominant" },
            { value: 1, label: "Significant", description: "Invasive species dominant or causing harm" }
          ]
        },
        {
          id: "wildlife-activity",
          text: "Wildlife activity signs",
          description: "Assess evidence of wildlife presence and diversity.",
          options: [
            { value: 3, label: "Abundant", description: "Diverse wildlife signs (tracks, nests, sightings)" },
            { value: 2, label: "Moderate", description: "Some wildlife signs but limited diversity" },
            { value: 1, label: "Limited", description: "Few or no signs of wildlife activity" }
          ]
        },
        {
          id: "canopy-cover",
          text: "Tree canopy cover",
          description: "Evaluate the extent and health of tree canopy coverage.",
          options: [
            { value: 3, label: "Extensive", description: "Dense, multi-layered canopy with mature trees" },
            { value: 2, label: "Moderate", description: "Partial canopy coverage with some gaps" },
            { value: 1, label: "Sparse", description: "Minimal canopy coverage, mostly open" }
          ]
        },
        {
          id: "pollinator-signs",
          text: "Pollinator activity",
          description: "Assess signs of pollinator insects and other species.",
          options: [
            { value: 3, label: "Abundant", description: "Frequent pollinator sightings on diverse plants" },
            { value: 2, label: "Moderate", description: "Some pollinator activity but limited" },
            { value: 1, label: "Limited", description: "Few or no pollinators observed" }
          ]
        },
    {
      id: "water-retention",
      text: "Water retention capacity",
      description: "Evaluate how well the landscape absorbs and retains water.",
      options: [
        { value: 3, label: "Excellent", description: "Good infiltration, minimal runoff, healthy wetlands" },
        { value: 2, label: "Moderate", description: "Some runoff but with natural drainage patterns" },
        { value: 1, label: "Poor", description: "Significant runoff, erosion, or drainage issues" }
      ]
    },
    {
      id: "microbial-activity",
      text: "Soil microbial activity",
      description: "Assess signs of healthy soil biology like earthworms and fungal networks.",
      options: [
        { value: 3, label: "High", description: "Abundant soil life, fungal networks visible" },
        { value: 2, label: "Moderate", description: "Some biological activity present" },
        { value: 1, label: "Low", description: "Little visible soil life, compacted soil" }
      ]
    },
    {
      id: "carbon-sequestration",
      text: "Carbon sequestration potential",
      description: "Evaluate the landscape's ability to store carbon.",
      options: [
        { value: 3, label: "High", description: "Diverse perennial vegetation, healthy soils" },
        { value: 2, label: "Moderate", description: "Some carbon-storing features present" },
        { value: 1, label: "Low", description: "Mostly annual plants, exposed soil" }
      ]
    },
    {
      id: "habitat-connectivity",
      text: "Habitat connectivity",
      description: "Assess how well wildlife can move between habitat patches.",
      options: [
        { value: 3, label: "Excellent", description: "Connected corridors, diverse habitat types" },
        { value: 2, label: "Moderate", description: "Some connectivity but with barriers" },
        { value: 1, label: "Poor", description: "Fragmented habitats with little connectivity" }
      ]
    },
    {
      id: "disturbance-regime",
      text: "Natural disturbance regime",
      description: "Evaluate if natural processes like fire/flood are functioning properly.",
      options: [
        { value: 3, label: "Balanced", description: "Natural disturbances occur at appropriate intervals" },
        { value: 2, label: "Altered", description: "Some suppression or unnatural frequency" },
        { value: 1, label: "Disrupted", description: "Complete suppression or extreme alteration" }
      ]
    },
    {
      id: "keystone-species",
      text: "Keystone species presence",
      description: "Assess presence of species critical to ecosystem function.",
      options: [
        { value: 3, label: "Present", description: "Key species present and functioning normally" },
        { value: 2, label: "Some", description: "Some key species present but populations low" },
        { value: 1, label: "Absent", description: "Key species missing or non-functional" }
      ]
    },
    {
      id: "cultural-significance",
      text: "Cultural/indigenous significance",
      description: "Evaluate preservation of culturally important ecological features.",
      options: [
        { value: 3, label: "Protected", description: "Cultural knowledge actively maintained" },
        { value: 2, label: "Some", description: "Some cultural features remain" },
        { value: 1, label: "Lost", description: "Cultural connections largely lost" }
      ]
    },
    {
      id: "climate-resilience",
      text: "Climate resilience indicators",
      description: "Assess signs of ecosystem adapting to climate change.",
      options: [
        { value: 3, label: "Resilient", description: "Diverse age classes, genetic diversity" },
        { value: 2, label: "Moderate", description: "Some adaptive capacity present" },
        { value: 1, label: "Vulnerable", description: "Little evidence of adaptation" }
      ]
    }
  ],
      recommendations: {
        low: [
          {
            title: "Immediate invasive species control",
            description: "Prioritize removal of dominant invasive species to allow native species recovery.",
            priority: "High",
            timeline: "Immediate",
            icon: "fas fa-tree"
          },
          {
            title: "Erosion control measures",
            description: "Implement erosion control such as planting ground cover, creating berms, or installing silt fences.",
            priority: "High",
            timeline: "Within 1 month",
            icon: "fas fa-water"
          },
          {
            title: "Native species planting",
            description: "Begin a phased planting program with diverse native species suited to the area.",
            priority: "Medium",
            timeline: "Next planting season",
            icon: "fas fa-seedling"
          },
    {
      title: "Water retention improvements",
      description: "Implement swales, rain gardens, or wetland restoration to improve water retention.",
      priority: "High",
      timeline: "Within 6 months",
      icon: "fas fa-tint"
    },
    {
      title: "Soil biology enhancement",
      description: "Apply compost teas, fungal inoculants, or organic matter to boost microbial activity.",
      priority: "High",
      timeline: "Next growing season",
      icon: "fas fa-bacteria"
    }
  ],
  medium: [
          {
            title: "Targeted invasive removal",
            description: "Remove invasive species in prioritized areas to protect native biodiversity.",
            priority: "Medium",
            timeline: "Within 3 months",
            icon: "fas fa-trash-alt"
          },
          {
            title: "Habitat enhancement",
            description: "Add features like nesting boxes, pollinator gardens, or water sources.",
            priority: "Medium",
            timeline: "Within 6 months",
            icon: "fas fa-home"
          },
          {
            title: "Community monitoring program",
            description: "Establish regular monitoring with community involvement to track changes.",
            priority: "Low",
            timeline: "Within 1 year",
            icon: "fas fa-users"
          },
    {
      title: "Carbon farming practices",
      description: "Implement agroforestry, cover cropping, or reduced tillage to increase carbon sequestration.",
      priority: "Medium",
      timeline: "Within 1 year",
      icon: "fas fa-cloud"
    },
    {
      title: "Wildlife corridor creation",
      description: "Plant native vegetation strips to connect habitat patches.",
      priority: "Medium",
      timeline: "Within 2 years",
      icon: "fas fa-route"
    }
  ],
        high: [
          {
            title: "Maintenance monitoring",
            description: "Continue regular monitoring to maintain ecosystem health.",
            priority: "Low",
            timeline: "Ongoing",
            icon: "fas fa-clipboard-list"
          },
          {
            title: "Selective enhancement",
            description: "Identify opportunities to add rare native species or microhabitats.",
            priority: "Low",
            timeline: "Next planting season",
            icon: "fas fa-plus-circle"
          },
          {
            title: "Education and outreach",
            description: "Share your success and methods with the community to inspire others.",
            priority: "Medium",
            timeline: "Within 1 year",
            icon: "fas fa-chalkboard-teacher"
          },
    {
      title: "Keystone species reintroduction",
      description: "Consider reintroducing missing keystone species where appropriate.",
      priority: "Low",
      timeline: "Long-term planning",
      icon: "fas fa-paw"
    },
    {
      title: "Cultural knowledge integration",
      description: "Work with indigenous communities to restore traditional ecological knowledge.",
      priority: "Medium",
      timeline: "Ongoing",
      icon: "fas fa-people-arrows"
    }
  ]
},
scoreDescriptions: {
  low: "Ecosystem shows significant degradation across multiple indicators. Comprehensive restoration needed.",
  medium: "Ecosystem is functioning but shows stress in key areas. Targeted improvements recommended.",
  high: "Ecosystem is healthy and resilient. Focus on maintenance and monitoring."
}
    };

    // =============================================
    // APP STATE
    // =============================================
    let appState = {
      currentAnswers: {},
      previousAssessments: [],
      currentScore: 0,
      charts: {},
      darkMode: false,
      map: null,
      marker: null,
      geocoder: null,
      currentPhotos: [],
      photoCounter: 0,
      currentAssessmentId: null,
      viewMode: null // 'new', 'history', or 'import'
    };

    // =============================================
    // DOM ELEMENTS
    // =============================================
    const elements = {
      welcomeScreen: document.getElementById('welcome-screen'),
      appContainer: document.getElementById('app-container'),
      newAssessmentCard: document.getElementById('new-assessment-card'),
      viewAssessmentsCard: document.getElementById('view-assessments-card'),
      importDataCard: document.getElementById('import-data-card'),
      questionsContainer: document.getElementById('questions-container'),
      resultContainer: document.getElementById('result-container'),
      assessmentCard: document.getElementById('assessment-card'),
      progressFill: document.getElementById('progress-fill'),
      progressText: document.getElementById('progress-text'),
      submitBtn: document.getElementById('submit-btn'),
      scoreDisplay: document.getElementById('score-display'),
      scoreDescription: document.getElementById('score-description'),
      generalFeedback: document.getElementById('general-feedback'),
      recommendationsContainer: document.getElementById('recommendations-container'),
      timelineContainer: document.getElementById('timeline-container'),
      historyContainer: document.getElementById('history-container'),
      radarChartContainer: document.getElementById('radar-chart-container'),
      trendChartContainer: document.getElementById('trend-chart-container'),
      newAssessmentBtn: document.getElementById('new-assessment-btn'),
      saveSurveyBtn: document.getElementById('save-survey-btn'),
      savePhotosBtn: document.getElementById('save-photos-btn'),
      printBtn: document.getElementById('print-btn'),
      exportPdfBtn: document.getElementById('export-pdf-btn'),
      exportFileBtn: document.getElementById('export-file-btn'),
      backBtn: document.getElementById('back-btn'),
      themeToggle: document.getElementById('theme-toggle'),
      tabs: document.querySelectorAll('.tab'),
      tabContents: document.querySelectorAll('.tab-content'),
      locationInput: document.getElementById('location-input'),
      saveLocationBtn: document.getElementById('save-location-btn'),
      mapContainer: document.getElementById('map-container'),
      map: document.getElementById('map'),
      mapPlaceholder: document.getElementById('map-placeholder'),
      uploadArea: document.getElementById('upload-area'),
      photoUpload: document.getElementById('photo-upload'),
      photoPreview: document.getElementById('photo-preview'),
      photoCaption: document.getElementById('photo-caption'),
      assessmentName: document.getElementById('assessment-name'),
      importFile: document.getElementById('import-file'),
      exportBtn: document.getElementById('export-btn'),
      importBtn: document.getElementById('import-btn')
    };

    // =============================================
    // INITIALIZATION
    // =============================================
    function initApp() {
      loadPreviousAssessments();
      setupEventListeners();
      initTheme();
    }

    function showWelcomeScreen() {
      elements.welcomeScreen.classList.remove('hidden');
      elements.appContainer.classList.add('hidden');
    }

    function showAppScreen(viewMode = 'new') {
      elements.welcomeScreen.classList.add('hidden');
      elements.appContainer.classList.remove('hidden');
      appState.viewMode = viewMode;

      // Initialize based on view mode
      if (viewMode === 'new') {
        startNewAssessment();
      } else if (viewMode === 'history') {
        showAssessmentHistory();
      }
    }

    function startNewAssessment() {
      resetAssessment();
      renderQuestions();
      checkProgress();
      initMap();
    }

    function showAssessmentHistory() {
      elements.assessmentCard.classList.add('hidden');
      elements.resultContainer.classList.remove('hidden');
      renderHistory();
      switchTab({ target: document.querySelector('.tab[data-tab="history"]') });
    }

    // =============================================
    // THEME MANAGEMENT
    // =============================================
    function initTheme() {
      const savedTheme = localStorage.getItem('darkMode');
      if (savedTheme === 'true') {
        enableDarkMode();
      } else {
        disableDarkMode();
      }
      updateThemeToggle();
    }

    function updateThemeToggle() {
      if (elements.themeToggle) {
        elements.themeToggle.checked = appState.darkMode;
      }
    }

    function toggleTheme() {
      if (appState.darkMode) {
        disableDarkMode();
      } else {
        enableDarkMode();
      }
      updateThemeToggle();
    }

    function enableDarkMode() {
      document.documentElement.setAttribute('data-theme', 'dark');
      appState.darkMode = true;
      localStorage.setItem('darkMode', 'true');
      refreshCharts();
    }

    function disableDarkMode() {
      document.documentElement.removeAttribute('data-theme');
      appState.darkMode = false;
      localStorage.setItem('darkMode', 'false');
      refreshCharts();
    }

    function refreshCharts() {
      if (appState.previousAssessments.length > 0 && appState.charts.radar) {
        const lastAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
        createRadarChart(lastAssessment.categoryScores);
      }
      if (appState.previousAssessments.length > 0 && appState.charts.trend) {
        createTrendChart();
      }
    }

    // =============================================
    // MAP FUNCTIONALITY
    // =============================================
    function initMap() {
      const defaultCoords = [-41.0524, 145.9042]; // Default to Burnie, Tasmania
      
      appState.map = L.map('map', {
        zoomControl: false
      }).setView(defaultCoords, 10);
      
      L.control.zoom({
        position: 'topright'
      }).addTo(appState.map);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(appState.map);
      
      // Create custom green marker
      const greenIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
      
      // Create marker (initially hidden)
      appState.marker = L.marker(defaultCoords, {
        icon: greenIcon,
        opacity: 0
      }).addTo(appState.map);
      
      // Ensure map fills container
      setTimeout(() => {
        appState.map.invalidateSize();
      }, 0);
      
      // Handle window resizing
      window.addEventListener('resize', () => {
        appState.map.invalidateSize();
      });
    }
    
    function geocodeLocation(location) {
      if (!location) return;
      
      elements.mapPlaceholder.classList.add('hidden');
      
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            
            // Update map view
            appState.map.setView([lat, lon], 14);
            
            // Update marker
            appState.marker
              .setLatLng([lat, lon])
              .setOpacity(1)
              .bindPopup(`<strong>Assessment Location</strong><br>${location}`)
              .openPopup();
          } else {
            elements.mapPlaceholder.classList.remove('hidden');
            console.error('Location not found');
          }
        })
        .catch(error => {
          elements.mapPlaceholder.classList.remove('hidden');
          console.error('Geocoding error:', error);
        });
    }

    // =============================================
    // ASSESSMENT QUESTIONS
    // =============================================
    function renderQuestions() {
      let html = '';
      
      ecoData.questions.forEach((question, index) => {
        html += `
          <div class="question" id="q-${question.id}">
            <div class="question-text">
              <span class="badge">Question ${index + 1}</span>
              ${question.text}
              <div class="tooltip">
                <i class="fas fa-info-circle"></i>
                <span class="tooltiptext">${question.description}</span>
              </div>
            </div>
            
            <div class="options">
              ${question.options.map(option => `
                <div class="option">
                  <input type="radio" 
                         id="${question.id}-${option.value}" 
                         name="${question.id}" 
                         value="${option.value}"
                         data-question="${question.id}">
                  <label for="${question.id}-${option.value}">
                    ${option.label}
                    <div class="small" style="margin-top: 5px;">${option.description}</div>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      
      elements.questionsContainer.innerHTML = html;
      
      // If we're editing an existing assessment, restore the answers
      if (appState.currentAssessmentId !== null) {
        const assessment = appState.previousAssessments.find(a => a.id === appState.currentAssessmentId);
        if (assessment) {
          Object.keys(assessment.answers).forEach(questionId => {
            const value = assessment.answers[questionId];
            const radio = document.querySelector(`input[name="${questionId}"][value="${value}"]`);
            if (radio) {
              radio.checked = true;
              appState.currentAnswers[questionId] = value;
            }
          });
          checkProgress();
        }
      }
    }

function checkProgress() {
  const answered = Object.keys(appState.currentAnswers).length;
  const total = ecoData.questions.length;
  const percent = Math.round((answered / total) * 100);
  
  elements.progressFill.style.width = `${percent}%`;
  elements.progressText.textContent = `${percent}% complete (${answered}/${total} questions)`;
  
  // Change button text when nearing completion
  if (percent >= 80) {
    elements.submitBtn.innerHTML = '<i class="fas fa-calculator"></i> Almost Done!';
  } else {
    elements.submitBtn.innerHTML = '<i class="fas fa-calculator"></i> Calculate Score';
  }
  
  elements.submitBtn.disabled = answered < total;
}

    // =============================================
    // ASSESSMENT CALCULATION & RESULTS
    // =============================================
    function calculateScore() {
      // Validate assessment name
      const assessmentName = elements.assessmentName.value.trim();
      if (!assessmentName) {
        alert('Please provide a name for this assessment');
        elements.assessmentName.focus();
        return;
      }

      // Calculate raw score
      let rawScore = 0;
      let maxScore = 0;
      const categoryScores = {};
      
      ecoData.questions.forEach(question => {
        const value = appState.currentAnswers[question.id] || 0;
        rawScore += value;
        maxScore += 3;
        
        // For radar chart
        const category = question.text;
        categoryScores[category] = value;
      });
      
      // Calculate percentage
      const percentScore = Math.round((rawScore / maxScore) * 100);
      appState.currentScore = percentScore;
      
      // Save assessment
      saveAssessment(percentScore, categoryScores);
      
      // Display results
      displayResults(percentScore, categoryScores);
    }

    function displayResults(score, categoryScores) {
      // Show result container
      elements.assessmentCard.classList.add('hidden');
      elements.resultContainer.classList.remove('hidden');
      
      // Set score display
      elements.scoreDisplay.textContent = score;
      
      // Determine score category
      let scoreClass, description;
      if (score < 40) {
        scoreClass = 'score-low';
        description = ecoData.scoreDescriptions.low;
      } else if (score < 70) {
        scoreClass = 'score-medium';
        description = ecoData.scoreDescriptions.medium;
      } else {
        scoreClass = 'score-high';
        description = ecoData.scoreDescriptions.high;
      }
      
      // Apply score class
      elements.scoreDisplay.className = `score-display ${scoreClass} pulse`;
      elements.scoreDescription.textContent = description;
      elements.generalFeedback.textContent = description;
      
      // Render recommendations
      renderRecommendations(score);
      
      // Create radar chart
      createRadarChart(categoryScores);
      
      // Create trend chart if we have history
      if (appState.previousAssessments.length > 0) {
        createTrendChart();
      }
      
      // Scroll to results
      elements.resultContainer.scrollIntoView({ behavior: 'smooth' });
    }

    function renderRecommendations(score) {
  let recommendations;
  if (score < 40) {
    recommendations = [...ecoData.recommendations.low];
    // Add critical actions for low scores
    recommendations.unshift({
      title: "URGENT: Ecosystem Triage",
      description: "Immediate intervention needed to prevent irreversible damage.",
      priority: "Critical",
      timeline: "Immediate",
      icon: "fas fa-exclamation-triangle"
    });
  } else if (score < 70) {
    recommendations = ecoData.recommendations.medium;
  } else {
    recommendations = ecoData.recommendations.high;
  }
  
  // Group by priority for better organization
  const groupedRecs = {
    Critical: [],
    High: [],
    Medium: [],
    Low: []
  };
  
  recommendations.forEach(rec => {
    groupedRecs[rec.priority].push(rec);
  });
  
  // Render grouped recommendations
  let html = '';
  Object.entries(groupedRecs).forEach(([priority, recs]) => {
    if (recs.length > 0) {
      html += `<h4>${priority} Priority Actions</h4>`;
      html += recs.map(rec => `
        <div class="recommendation">
          <i class="${rec.icon}"></i>
          <div>
            <h4>${rec.title}</h4>
            <p>${rec.description}</p>
            <p class="small"><strong>Timeline:</strong> ${rec.timeline}</p>
          </div>
        </div>
      `).join('');
    }
  });
  
  elements.recommendationsContainer.innerHTML = html;
  
  // Enhanced timeline visualization
  const timelineHtml = `
    <div class="timeline">
      ${recommendations.map(rec => `
        <div class="timeline-item">
          <div class="timeline-priority ${rec.priority.toLowerCase()}">
            ${rec.priority}
          </div>
          <div class="timeline-content">
            <h5>${rec.title}</h5>
            <div class="timeline-bar" style="width: ${getTimelineWidth(rec.timeline)}"></div>
            <span>${rec.timeline}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  
  elements.timelineContainer.innerHTML = timelineHtml;
}

    function getTimelineWidth(timeline) {
      switch (timeline.toLowerCase()) {
        case 'immediate': return '20%';
        case 'within 1 month': return '30%';
        case 'within 3 months': return '50%';
        case 'within 6 months': return '70%';
        case 'next planting season': return '80%';
        case 'within 1 year': return '90%';
        case 'ongoing': return '100%';
        default: return '50%';
      }
    }

// =============================================
// DATA VISUALIZATION
// =============================================
function createRadarChart(categoryScores) {
  const ctx = document.getElementById('radar-chart').getContext('2d');
  
  // Destroy previous chart if exists
  if (appState.charts.radar) {
    appState.charts.radar.destroy();
  }
  
  const labels = Object.keys(categoryScores);
  const data = Object.values(categoryScores);
  
  appState.charts.radar = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Category Scores',
        data: data,
        backgroundColor: 'rgba(46, 125, 50, 0.2)',
        borderColor: 'rgba(46, 125, 50, 1)',
        borderWidth: 2,
        pointBackgroundColor: 'rgba(46, 125, 50, 1)',
        pointRadius: 4
      }]
    },
    options: {
      scales: {
        r: {
          angleLines: {
            display: true
          },
          suggestedMin: 0,
          suggestedMax: 3,
          ticks: {
            stepSize: 1,
            backdropColor: 'rgba(0, 0, 0, 0)' // Makes the chart more readable with many categories
          },
          pointLabels: {
            font: {
              size: 10 // Smaller font for more labels
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.raw}/3`;
            }
          }
        }
      },
      elements: {
        line: {
          tension: 0.1 // Smoother lines for more points
        }
      }
    }
  });
}

function createTrendChart() {
  const ctx = document.getElementById('trend-chart').getContext('2d');
  
  // Destroy previous chart if exists
  if (appState.charts.trend) {
    appState.charts.trend.destroy();
  }      
      // Prepare data
      const assessments = [...appState.previousAssessments].reverse();
      const labels = assessments.map(a => a.date);
      const scores = assessments.map(a => a.score);
      const locations = assessments.map(a => a.location || 'Unspecified');
      
      appState.charts.trend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ecosystem Health Score',
            data: scores,
            backgroundColor: 'rgba(46, 125, 50, 0.2)',
            borderColor: 'rgba(46, 125, 50, 1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                afterLabel: function(context) {
                  const index = context.dataIndex;
                  return `Location: ${locations[index]}`;
                }
              }
            }
          }
        }
      });
    }

    // =============================================
    // ASSESSMENT MANAGEMENT
    // =============================================
    function loadPreviousAssessments() {
      const savedAssessments = localStorage.getItem('ecoAssessments');
      if (savedAssessments) {
        try {
          const parsed = JSON.parse(savedAssessments);
          // Ensure all assessments have an ID (for backward compatibility)
          appState.previousAssessments = parsed.map(assessment => {
            if (!assessment.id) {
              assessment.id = `assessment-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            }
            return assessment;
          });
        } catch (e) {
          console.error("Error loading assessments:", e);
          appState.previousAssessments = [];
        }
      }
    }

    function saveAssessment(score, categoryScores) {
      const assessmentName = elements.assessmentName.value.trim() || 
                           `Assessment ${appState.previousAssessments.length + 1}`;
      const location = elements.locationInput.value.trim();

      // Create or update assessment
      let assessment;
      if (appState.currentAssessmentId) {
        // Update existing assessment
        assessment = appState.previousAssessments.find(a => a.id === appState.currentAssessmentId);
        if (assessment) {
          assessment.name = assessmentName;
          assessment.score = score;
          assessment.categoryScores = categoryScores;
          assessment.answers = {...appState.currentAnswers};
          assessment.location = location;
          assessment.timestamp = Date.now();
          assessment.date = new Date().toLocaleDateString();
        }
      } else {
        // Create new assessment
        assessment = {
          id: `assessment-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
          name: assessmentName,
          date: new Date().toLocaleDateString(),
          score: score,
          categoryScores: categoryScores,
          answers: {...appState.currentAnswers},
          timestamp: Date.now(),
          location: location
        };
        appState.previousAssessments.push(assessment);
      }

      // Save photos if any were uploaded
      if (appState.currentPhotos.length > 0) {
        if (!assessment.photos) assessment.photos = [];
        assessment.photos.push(...appState.currentPhotos);
      }

      localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
      
      renderHistory();
      appState.currentAssessmentId = assessment.id;
      
      // Show success message
      alert(`Assessment "${assessmentName}" saved successfully!`);
    }

    function renderHistory() {
      if (appState.previousAssessments.length === 0) {
        elements.historyContainer.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-light);">
            <i class="fas fa-history fa-2x" style="margin-bottom: 10px;"></i>
            <p>No previous assessments found</p>
          </div>
        `;
        return;
      }
      
      // Sort by date (newest first)
      const sortedAssessments = [...appState.previousAssessments].sort((a, b) => b.timestamp - a.timestamp);
      
      let html = sortedAssessments.map((assessment) => {
        let scoreClass;
        if (assessment.score < 40) {
          scoreClass = 'score-low';
        } else if (assessment.score < 70) {
          scoreClass = 'score-medium';
        } else {
          scoreClass = 'score-high';
        }
        
        // Check if this assessment has photos
        const hasPhotos = assessment.photos && assessment.photos.length > 0;
        
        return `
          <div class="history-item" data-id="${assessment.id}">
            <div>
              <strong>${assessment.name || 'Unnamed Assessment'}</strong>
              <div class="small">${assessment.date} ‚Ä¢ ${assessment.location || 'No location'}</div>
              ${hasPhotos ? '<span class="badge"><i class="fas fa-camera"></i> Photos</span>' : ''}
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <div class="history-score ${scoreClass}">${assessment.score}/100</div>
              <button class="delete-assessment-btn" data-id="${assessment.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      elements.historyContainer.innerHTML = html;
      
      // Add click handlers to view historical assessments
      document.querySelectorAll('.history-item').forEach(item => {
        item.addEventListener('click', function(e) {
          // Don't trigger if clicking on delete button
          if (!e.target.closest('.delete-assessment-btn')) {
            const id = this.getAttribute('data-id');
            viewHistoricalAssessment(id);
          }
        });
      });
      
      // Add click handlers to delete buttons
      document.querySelectorAll('.delete-assessment-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const id = this.getAttribute('data-id');
          deleteAssessment(id);
        });
      });
    }

    function deleteAssessment(id) {
      if (confirm('Are you sure you want to delete this assessment? This cannot be undone.')) {
        // Remove the assessment from the array
        appState.previousAssessments = appState.previousAssessments.filter(a => a.id !== id);
        
        // If we deleted the current assessment, reset the UI
        if (appState.currentAssessmentId === id) {
          resetAssessment();
        }
        
        // Update localStorage
        localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
        
        // Re-render history
        renderHistory();
        
        // If we deleted the last assessment, reset the trend chart
        if (appState.previousAssessments.length === 0) {
          if (appState.charts.trend) {
            appState.charts.trend.destroy();
            document.getElementById('trend-chart-container').innerHTML = '<canvas id="trend-chart"></canvas>';
          }
        } else {
          // Otherwise update the trend chart
          createTrendChart();
        }
        
        // Show confirmation
        alert('Assessment deleted successfully');
      }
    }

    function viewHistoricalAssessment(id) {
      const assessment = appState.previousAssessments.find(a => a.id === id);
      if (!assessment) return;

      // Set current assessment ID
      appState.currentAssessmentId = id;

      // Update basic info
      elements.assessmentName.value = assessment.name || '';
      elements.locationInput.value = assessment.location || '';
      
      // Update score display
      elements.scoreDisplay.textContent = assessment.score;
      let scoreClass = assessment.score < 40 ? 'score-low' : 
                      assessment.score < 70 ? 'score-medium' : 'score-high';
      elements.scoreDisplay.className = `score-display ${scoreClass}`;
      elements.scoreDescription.textContent = 
        assessment.score < 40 ? ecoData.scoreDescriptions.low :
        assessment.score < 70 ? ecoData.scoreDescriptions.medium :
        ecoData.scoreDescriptions.high;

      // Update map if location exists
      if (assessment.location) {
        geocodeLocation(assessment.location);
      } else {
        elements.mapPlaceholder.classList.remove('hidden');
      }

      // Show photos if they exist
      if (assessment.photos && assessment.photos.length > 0) {
        elements.photoPreview.innerHTML = '';
        assessment.photos.forEach(photo => {
          renderPhotoThumbnail(photo);
        });
      } else {
        elements.photoPreview.innerHTML = '';
      }

      // Show survey data if it exists
      if (assessment.survey) {
        document.getElementById('survey-date').value = assessment.survey.date || '';
        document.getElementById('plant-species').value = assessment.survey.plantSpecies || '';
        document.getElementById('animal-species').value = assessment.survey.animalSpecies || '';
        document.getElementById('dominant-species').value = assessment.survey.dominantSpecies || '';
        document.getElementById('rare-species').value = assessment.survey.rareSpecies || '';
        document.getElementById('survey-notes').value = assessment.survey.notes || '';
      }

      // Create radar chart
      createRadarChart(assessment.categoryScores);
      
      // Render recommendations
      renderRecommendations(assessment.score);
      
      // Show the assessment card with answers
      elements.assessmentCard.classList.remove('hidden');
      elements.resultContainer.classList.remove('hidden');
      renderQuestions();
      
      // Switch to summary tab
      switchTab({ target: document.querySelector('.tab[data-tab="summary"]') });
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetAssessment() {
      // Reset state
      appState.currentAnswers = {};
      appState.currentPhotos = [];
      appState.currentAssessmentId = null;
      appState.currentScore = 0;
      
      // Reset UI
      elements.assessmentCard.classList.remove('hidden');
      elements.resultContainer.classList.add('hidden');
      elements.progressFill.style.width = '0%';
      elements.progressText.textContent = '0% complete';
      elements.submitBtn.disabled = true;
      elements.photoPreview.innerHTML = '';
      elements.photoCaption.value = '';
      elements.assessmentName.value = `Assessment ${appState.previousAssessments.length + 1}`;
      elements.locationInput.value = '';
      
      // Reset survey fields
      document.getElementById('survey-date').value = '';
      document.getElementById('plant-species').value = '';
      document.getElementById('animal-species').value = '';
      document.getElementById('dominant-species').value = '';
      document.getElementById('rare-species').value = '';
      document.getElementById('survey-notes').value = '';
      
      // Uncheck all radio buttons
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
      });
      
      // Reset map
      elements.mapPlaceholder.classList.remove('hidden');
      if (appState.marker) appState.marker.setOpacity(0);
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // =============================================
    // FILE-BASED SAVE/LOAD
    // =============================================
    function saveAssessmentToFile() {
      if (appState.previousAssessments.length === 0) {
        alert("No assessments to save");
        return;
      }

      // Create a data structure with version info and assessments
      const saveData = {
        version: "1.0",
        timestamp: new Date().toISOString(),
        assessments: appState.previousAssessments
      };

      const data = JSON.stringify(saveData, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `EcoVision_Data_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function loadAssessmentFromFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = event => {
          try {
            const fileData = JSON.parse(event.target.result);
            
            // Validate file structure
            if (!fileData.assessments || !Array.isArray(fileData.assessments)) {
              throw new Error("Invalid file format - assessments array missing");
            }

            // Validate each assessment
            const isValid = fileData.assessments.every(assessment => {
              return assessment.hasOwnProperty('score') && 
                     assessment.hasOwnProperty('answers') &&
                     assessment.hasOwnProperty('categoryScores');
            });

            if (!isValid) {
              throw new Error("Invalid assessment data in file");
            }

            // Replace current data with loaded data
            appState.previousAssessments = fileData.assessments.map(assessment => {
              // Ensure each assessment has an ID
              if (!assessment.id) {
                assessment.id = `assessment-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
              }
              return assessment;
            });

            localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
            
            // Refresh UI
            renderHistory();
            createTrendChart();
            
            // Show success message
            alert(`${fileData.assessments.length} assessment(s) loaded successfully!`);
            
            // Switch to history view
            showAppScreen('history');
            
          } catch (error) {
            console.error("Error loading file:", error);
            alert(`Error loading file: ${error.message}`);
          }
        };
        reader.onerror = () => {
          alert("Error reading file");
        };
        reader.readAsText(file);
      };
      
      input.click();
    }

    // =============================================
    // PHOTO MANAGEMENT
    // =============================================  
      function handlePhotoUpload(files) {
      if (!files || files.length === 0) return;
      
      // Limit to 10 photos per assessment
      const remainingSlots = 10 - appState.currentPhotos.length;
      if (remainingSlots <= 0) {
        alert('Maximum of 10 photos per assessment reached');
        return;
      }
      
      const filesToUpload = Array.from(files).slice(0, remainingSlots);
      
      filesToUpload.forEach(file => {
        if (!file.type.match('image.*')) {
          alert(`Skipped ${file.name} - only image files are allowed`);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const photoId = `photo-${Date.now()}-${appState.photoCounter++}`;
          const photoObj = {
            id: photoId,
            data: e.target.result,
            file: file,
            caption: elements.photoCaption.value.trim(),
            timestamp: new Date().toISOString()
          };
          
          appState.currentPhotos.push(photoObj);
          renderPhotoThumbnail(photoObj);
        };
        reader.readAsDataURL(file);
      });
      
      // Reset file input to allow uploading same files again
      elements.photoUpload.value = '';
    }

    function renderPhotoThumbnail(photo) {
      const thumbnail = document.createElement('div');
      thumbnail.style.position = 'relative';
      thumbnail.style.display = 'inline-block';
      
      const img = document.createElement('img');
      img.src = photo.data;
      img.className = 'photo-thumbnail';
      img.alt = 'Uploaded photo preview';
      
      const removeBtn = document.createElement('span');
      removeBtn.className = 'remove-photo';
      removeBtn.innerHTML = '&times;';
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removePhoto(photo.id);
      });
      
      thumbnail.appendChild(img);
      thumbnail.appendChild(removeBtn);
      elements.photoPreview.appendChild(thumbnail);
      
      // Add click to view larger
      thumbnail.addEventListener('click', () => viewPhoto(photo));
    }

    function removePhoto(photoId) {
      appState.currentPhotos = appState.currentPhotos.filter(p => p.id !== photoId);
      
      // Re-render all thumbnails
      elements.photoPreview.innerHTML = '';
      appState.currentPhotos.forEach(photo => renderPhotoThumbnail(photo));
    }

    function viewPhoto(photo) {
      // Create modal overlay
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
      modal.style.display = 'flex';
      modal.style.flexDirection = 'column';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '1000';
      modal.style.padding = '20px';
      modal.style.boxSizing = 'border-box';
      
      // Create close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-danger';
      closeBtn.style.position = 'absolute';
      closeBtn.style.top = '20px';
      closeBtn.style.right = '20px';
      closeBtn.innerHTML = '<i class="fas fa-times"></i> Close';
      closeBtn.addEventListener('click', () => document.body.removeChild(modal));
      
      // Create image container
      const imgContainer = document.createElement('div');
      imgContainer.style.maxWidth = '90%';
      imgContainer.style.maxHeight = '80%';
      imgContainer.style.display = 'flex';
      imgContainer.style.justifyContent = 'center';
      imgContainer.style.alignItems = 'center';
      
      // Create image
      const img = document.createElement('img');
      img.src = photo.data;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      img.style.objectFit = 'contain';
      
      // Create caption
      const caption = document.createElement('div');
      caption.style.color = 'white';
      caption.style.marginTop = '15px';
      caption.style.textAlign = 'center';
      caption.textContent = photo.caption || 'No caption provided';
      
      // Add elements to modal
      imgContainer.appendChild(img);
      modal.appendChild(closeBtn);
      modal.appendChild(imgContainer);
      modal.appendChild(caption);
      
      // Add to document
      document.body.appendChild(modal);
    }

    function savePhotos() {
      // Update all photos with current caption if they don't have one
      const caption = elements.photoCaption.value.trim();
      appState.currentPhotos.forEach(photo => {
        if (!photo.caption && caption) {
          photo.caption = caption;
        }
      });
      
      // Get current assessment
      let currentAssessment;
      if (appState.currentAssessmentId) {
        currentAssessment = appState.previousAssessments.find(a => a.id === appState.currentAssessmentId);
      } else {
        // If no current assessment (shouldn't happen), use the last one
        currentAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
      }

      if (currentAssessment) {
        if (!currentAssessment.photos) {
          currentAssessment.photos = [];
        }
        
        // Add new photos
        currentAssessment.photos.push(...appState.currentPhotos);
        localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
        
        // Show success message
        alert(`${appState.currentPhotos.length} photos saved successfully!`);
        
        // Reset photo state
        appState.currentPhotos = [];
        elements.photoPreview.innerHTML = '';
        elements.photoCaption.value = '';
      } else {
        alert('Error: No current assessment found to attach photos to.');
      }
    }

    // =============================================
    // BIODIVERSITY SURVEY
    // =============================================
    function saveSurvey() {
      const survey = {
        date: document.getElementById('survey-date').value || new Date().toISOString().split('T')[0],
        plantSpecies: document.getElementById('plant-species').value,
        animalSpecies: document.getElementById('animal-species').value,
        dominantSpecies: document.getElementById('dominant-species').value,
        rareSpecies: document.getElementById('rare-species').value,
        notes: document.getElementById('survey-notes').value
      };
      
      // Get current assessment
      let currentAssessment;
      if (appState.currentAssessmentId) {
        currentAssessment = appState.previousAssessments.find(a => a.id === appState.currentAssessmentId);
      } else {
        // If no current assessment (shouldn't happen), use the last one
        currentAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
      }

      if (currentAssessment) {
        currentAssessment.survey = survey;
        localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
        
        // Show success message
        alert('Biodiversity survey saved successfully!');
      } else {
        alert('Error: No current assessment found to attach survey to.');
      }
    }

    // =============================================
    // PDF EXPORT
    // =============================================
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Get current assessment
      let assessment;
      if (appState.currentAssessmentId) {
        assessment = appState.previousAssessments.find(a => a.id === appState.currentAssessmentId);
      } else if (appState.previousAssessments.length > 0) {
        assessment = appState.previousAssessments[appState.previousAssessments.length - 1];
      } else {
        alert("No assessment data available to export");
        return;
      }

      // Create a temporary div for PDF content
      const pdfContainer = document.createElement('div');
      pdfContainer.className = 'pdf-container';
      pdfContainer.style.position = 'absolute';
      pdfContainer.style.left = '-9999px';
      document.body.appendChild(pdfContainer);

      // Header
      const header = document.createElement('div');
      header.className = 'pdf-header';
      header.innerHTML = `
        <div class="pdf-logo">
          <i class="fas fa-leaf"></i> EcoVision Elite
        </div>
        <h1>${assessment.name || 'Ecosystem Assessment'}</h1>
        <p>${assessment.date} ‚Ä¢ ${assessment.location || 'Location not specified'}</p>
      `;
      pdfContainer.appendChild(header);

      // Score section
      const scoreSection = document.createElement('div');
      scoreSection.className = 'pdf-section';
      let scoreClass = 'pdf-score-';
      let scoreDescription = '';
      
      if (assessment.score < 40) {
        scoreClass += 'low';
        scoreDescription = ecoData.scoreDescriptions.low;
      } else if (assessment.score < 70) {
        scoreClass += 'medium';
        scoreDescription = ecoData.scoreDescriptions.medium;
      } else {
        scoreClass += 'high';
        scoreDescription = ecoData.scoreDescriptions.high;
      }
      
      scoreSection.innerHTML = `
        <div class="pdf-section-title">Assessment Score</div>
        <div class="${scoreClass}">${assessment.score}/100</div>
        <p>${scoreDescription}</p>
      `;
      pdfContainer.appendChild(scoreSection);

      // Category scores
      const categoriesSection = document.createElement('div');
      categoriesSection.className = 'pdf-section';
      let categoriesHtml = '<div class="pdf-section-title">Category Scores</div><table style="width:100%;border-collapse:collapse;">';
      
      for (const [category, score] of Object.entries(assessment.categoryScores)) {
        categoriesHtml += `
          <tr style="border-bottom:1px solid #ddd;">
            <td style="padding:8px;">${category}</td>
            <td style="padding:8px;text-align:right;">${score}/3</td>
          </tr>
        `;
      }
      
      categoriesHtml += '</table>';
      categoriesSection.innerHTML = categoriesHtml;
      pdfContainer.appendChild(categoriesSection);

      // Recommendations
      const recommendationsSection = document.createElement('div');
      recommendationsSection.className = 'pdf-section';
      let recommendationsHtml = '<div class="pdf-section-title">Recommendations</div>';
      
      let recommendations;
      if (assessment.score < 40) {
        recommendations = ecoData.recommendations.low;
      } else if (assessment.score < 70) {
        recommendations = ecoData.recommendations.medium;
      } else {
        recommendations = ecoData.recommendations.high;
      }
      
      recommendations.forEach(rec => {
        recommendationsHtml += `
          <div style="margin-bottom:15px;">
            <h4 style="margin:0 0 5px 0;">${rec.title}</h4>
            <p style="margin:0 0 5px 0;">${rec.description}</p>
            <p style="margin:0;font-size:0.9em;"><strong>Priority:</strong> ${rec.priority} ‚Ä¢ <strong>Timeline:</strong> ${rec.timeline}</p>
          </div>
        `;
      });
      
      recommendationsSection.innerHTML = recommendationsHtml;
      pdfContainer.appendChild(recommendationsSection);

      // Survey data if available
      if (assessment.survey) {
        const surveySection = document.createElement('div');
        surveySection.className = 'pdf-section';
        surveySection.innerHTML = `
          <div class="pdf-section-title">Biodiversity Survey</div>
          <table style="width:100%;border-collapse:collapse;">
            <tr style="border-bottom:1px solid #ddd;">
              <td style="padding:8px;">Survey Date</td>
              <td style="padding:8px;">${assessment.survey.date || 'Not specified'}</td>
            </tr>
            <tr style="border-bottom:1px solid #ddd;">
              <td style="padding:8px;">Native Plant Species</td>
              <td style="padding:8px;">${assessment.survey.plantSpecies || 'Not recorded'}</td>
            </tr>
            <tr style="border-bottom:1px solid #ddd;">
              <td style="padding:8px;">Animal Species Observed</td>
              <td style="padding:8px;">${assessment.survey.animalSpecies || 'Not recorded'}</td>
            </tr>
            <tr style="border-bottom:1px solid #ddd;">
              <td style="padding:8px;">Dominant Species</td>
              <td style="padding:8px;">${assessment.survey.dominantSpecies || 'Not recorded'}</td>
            </tr>
            <tr style="border-bottom:1px solid #ddd;">
              <td style="padding:8px;">Rare/Endangered Species</td>
              <td style="padding:8px;">${assessment.survey.rareSpecies || 'Not recorded'}</td>
            </tr>
          </table>
          ${assessment.survey.notes ? `<p><strong>Notes:</strong> ${assessment.survey.notes}</p>` : ''}
        `;
        pdfContainer.appendChild(surveySection);
      }

      // Photos if available
      if (assessment.photos && assessment.photos.length > 0) {
        const photosSection = document.createElement('div');
        photosSection.className = 'pdf-section';
        let photosHtml = '<div class="pdf-section-title">Photo Documentation</div><div class="pdf-photo-grid">';
        
        assessment.photos.forEach(photo => {
          photosHtml += `
            <div class="pdf-photo">
              <img src="${photo.data}" style="max-width:100%;height:auto;">
              <div class="pdf-photo-caption">${photo.caption || 'No caption'}</div>
            </div>
          `;
        });
        
        photosHtml += '</div>';
        photosSection.innerHTML = photosHtml;
        pdfContainer.appendChild(photosSection);
      }

      // Footer
      const footer = document.createElement('div');
      footer.className = 'pdf-footer';
      footer.innerHTML = `
        <p>Generated by EcoVision Elite on ${new Date().toLocaleDateString()}</p>
        <p>https://ecovisionpro.example.com</p>
      `;
      pdfContainer.appendChild(footer);

      // Convert to PDF
      html2canvas(pdfContainer).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 295; // A4 height in mm
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        // Save the PDF
        doc.save(`EcoVision_Assessment_${assessment.name || 'Untitled'}.pdf`);
        
        // Clean up
        document.body.removeChild(pdfContainer);
      });
    }

    // =============================================
    // UTILITY FUNCTIONS
    // =============================================
    function saveLocation() {
      const location = elements.locationInput.value.trim();
      if (!location) {
        alert('Please enter a location before saving');
        return;
      }
      
      // Get current assessment
      let currentAssessment;
      if (appState.currentAssessmentId) {
        currentAssessment = appState.previousAssessments.find(a => a.id === appState.currentAssessmentId);
      } else if (appState.previousAssessments.length > 0) {
        currentAssessment = appState.previousAssessments[appState.previousAssessments.length - 1];
      }

      if (currentAssessment) {
        currentAssessment.location = location;
        localStorage.setItem('ecoAssessments', JSON.stringify(appState.previousAssessments));
        
        // Update map
        geocodeLocation(location);
        alert('Location saved successfully!');
      } else {
        alert('Error: No current assessment found to save location to.');
      }
    }

    function switchTab(e) {
      const tab = e.target.getAttribute('data-tab');
      
      // Update active tab
      elements.tabs.forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      
      // Show corresponding content
      elements.tabContents.forEach(content => {
        content.classList.remove('active');
        if (content.id === `${tab}-tab`) {
          content.classList.add('active');
        }
      });
      
      // If switching to photos tab, clear any current uploads
      if (tab === 'photos') {
        appState.currentPhotos = [];
        elements.photoPreview.innerHTML = '';
        elements.photoCaption.value = '';
      }
    }

    // =============================================
    // EVENT LISTENERS
    // =============================================
    function setupEventListeners() {
      // Welcome screen buttons
      elements.newAssessmentCard.addEventListener('click', () => showAppScreen('new'));
      elements.viewAssessmentsCard.addEventListener('click', () => showAppScreen('history'));
      elements.importDataCard.addEventListener('click', loadAssessmentFromFile);

      // Back button
      elements.backBtn.addEventListener('click', showWelcomeScreen);

      // Theme toggle - now works on all pages
      document.addEventListener('change', function(e) {
        if (e.target.matches('#theme-toggle')) {
          toggleTheme();
        }
      });

      // Radio button changes
      document.addEventListener('change', function(e) {
        if (e.target.matches('input[type="radio"]')) {
          const questionId = e.target.getAttribute('data-question');
          appState.currentAnswers[questionId] = parseInt(e.target.value);
          checkProgress();
        }
      });
      
      // Modal buttons
document.getElementById('user-guide-card').addEventListener('click', () => {
  document.getElementById('user-guide-modal').classList.remove('hidden');
});

document.getElementById('terms-of-use-card').addEventListener('click', () => {
  document.getElementById('terms-modal').classList.remove('hidden');
});

// Close modals
document.querySelectorAll('.close-modal').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.add('hidden');
    });
  });
});

// Close when clicking outside modal
window.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.classList.add('hidden');
  }
});
      
      // Submit button
      elements.submitBtn.addEventListener('click', calculateScore);
      
      // New assessment button
      elements.newAssessmentBtn.addEventListener('click', resetAssessment);
      
      // Save survey button
      elements.saveSurveyBtn.addEventListener('click', saveSurvey);
      
      // Save photos button
      elements.savePhotosBtn.addEventListener('click', savePhotos);
      
      // Print button
      elements.printBtn.addEventListener('click', () => window.print());
      
      // PDF Export button
      elements.exportPdfBtn.addEventListener('click', exportToPDF);
      
      // File Export button
      elements.exportFileBtn.addEventListener('click', saveAssessmentToFile);
      
      // Tab switching
      elements.tabs.forEach(tab => {
        tab.addEventListener('click', switchTab);
      });
      
      // Save location
      elements.saveLocationBtn.addEventListener('click', saveLocation);
      
      // Photo upload handling
      elements.uploadArea.addEventListener('click', () => elements.photoUpload.click());
      
      // Drag and drop for photos
      elements.uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        elements.uploadArea.style.backgroundColor = 'rgba(46, 125, 50, 0.2)';
      });
      
      elements.uploadArea.addEventListener('dragleave', () => {
        elements.uploadArea.style.backgroundColor = '';
      });
      
      elements.uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.uploadArea.style.backgroundColor = '';
        handlePhotoUpload(e.dataTransfer.files);
      });
      
      // File input change
      elements.photoUpload.addEventListener('change', (e) => {
        handlePhotoUpload(e.target.files);
      });

      // Import/Export buttons in history tab
      elements.exportBtn.addEventListener('click', saveAssessmentToFile);
      elements.importBtn.addEventListener('click', loadAssessmentFromFile);
    }

    // =============================================
    // INITIALIZE THE APP
    // =============================================
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
  <!-- User Guide Modal -->
<div id="user-guide-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2><i class="fas fa-book"></i> EcoVision Elite User Guide</h2>
    <div class="modal-body">
      <h3>Getting Started</h3>
      <ol>
        <li>Click "New Assessment" to begin</li>
        <li>Name your assessment</li>
        <li>Answer all 7 ecosystem questions</li>
        <li>View your results and recommendations</li>
      </ol>
      
      <h3>Understanding Scores</h3>
      <ul>
        <li><strong>0-39 (Red):</strong> Needs improvement</li>
        <li><strong>40-69 (Orange):</strong> Moderate health</li>
        <li><strong>70-100 (Green):</strong> Healthy ecosystem</li>
      </ul>
    </div>
  </div>
</div>

<!-- Terms of Use Modal -->
<div id="terms-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2><i class="fas fa-file-contract"></i> Terms of Use</h2>
    <div class="modal-body">
      <h3>1. Data Privacy</h3>
      <p>All data is stored locally in your browser.</p>
      
      <h3>2. Disclaimer</h3>
      <p>Results are estimates only, not professional advice.</p>
    </div>
  </div>
</div>
</body>
    </html>
